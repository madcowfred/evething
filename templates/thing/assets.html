{% extends "base.html" %}
{% load thing_extras %}

{% block title %}Assets{% endblock %}

{% block extra_js %}
    <script type="text/javascript">

      // bind the asset expander buttons
      $(".asset-expand").on('click', function() {
        var $this = $(this);
        
        if ($this.hasClass('icons-expand')) {
          $this.addClass('icons-collapse').removeClass('icons-expand');
          $($this.attr('data-target')).each(function() {
            $(this).show();
          });
        }
        else {
          $this.addClass('icons-expand').removeClass('icons-collapse');
          $($this.attr('data-target')).each(function() {
            $(this).hide();
          });
        }
      });

      // bind the ship EFT fitting buttons
      $(".asset-eft").on('click', function() {
        var $this = $(this);
        var data_target = $('i:nth-child(1)', $this.parent()).attr('data-target');

        var parts = $.trim($(this).parent().text()).split(' - ');
        var ship_type = $.trim(parts[0]);
        if (parts.length == 2) {
          ship_name = $.trim(parts[1]);
        }
        else {
          ship_name = "From Assets";
        }

        $('#eft-textarea').empty();
        $('#eft-textarea').append('[' + ship_type + ', ' + ship_name + ']\n');

        var last_slot = null;

        $(data_target).each(function() {
          var slot = $.trim($('td:nth-child(3)', $(this)).text());
          if (slot.substr(-4) == "Slot") {
            if (last_slot && last_slot != slot) {
              $('#eft-textarea').append('\n');
            }
            last_slot = slot;

            var name = $.trim($('td:nth-child(2)', $(this)).text());
            $('#eft-textarea').append(name + '\n');
            //console.log("%s: %s", slot, name);
          }
        });

        $('#eft-modal').modal('show');
      });

      $('#eft-modal').on('shown', function() {
        $('#eft-textarea').select();
      });
    </script>
{% endblock %}

{% block content %}
      <div id="filters" class="row-fluid">
        <div class="span6">
          <h2>Assets</h2>

          <form class="well well-small" action="{% url thing.views.assets %}" method="GET">
            <h4>Search</h4>
            <fieldset>
              <input name="search" class="span9 filter-type input-large" value="{{search}}">
              </input>

            <button type="submit" class="btn btn-primary">Search</button>
            <a href="{% url thing.views.assets %}" class="btn btn-danger">Clear search</a>
            </fieldset>
          </form>
        </div>
      </div>

      <div class="row-fluid">
        <div class="span10">
          <p><strong>Total asset value:</strong> {{ total_value|commas }} ISK</p>
          {% with user.get_profile().show_item_icons as show_item_icons -%}
          {% for system_name, asset_roots in systems -%}
          <table class="table table-striped table-bordered table-condensed">
            <thead>
              <tr class="c">
                <th class="l" colspan="2">{{ system_name }}</th>
                <th class="c">Group</th>
                <th class="c">Quantity</th>
                <th class="c">Unit Value</th>
                <th class="c">Total Value</th>
              </tr>
            </thead>
            <tbody>
              {% for asset in asset_roots -%}
              <tr>
                <td class="assets-character">
                  {% if asset.z_corporation -%}
                  <i class="icons-corporation"></i> {{ asset.z_corporation.name }}
                  {%- else %}
                  <i class="icons-player"></i> {{ asset.z_character.name }}
                  {%- endif %}
                </td>
                <td class="assets-item">
                  {% if asset.z_contents -%}
                  <i class="icons-expand asset-expand" data-target=".asset-{{ asset.id }}"></i>
                  {%- endif %}
                  {% if show_item_icons -%}
                  <img src="http://image.eveonline.com/Type/{{ asset.z_item.id }}_32.png" height="20" width="20">
                  {%- endif %}
                  {{ asset.z_item.name }}
                  {%- if asset.name %} - <i>{{ asset.name }}</i>{% endif %}
                  {% if asset.z_contents and asset.z_item.item_group.category.name == 'Ship' -%}
                  <i class="icons-asset-eft pull-right asset-eft"></i>
                  {%- endif %}
                  {% if asset.z_blueprint == -1 -%}
                  <i class="icons-asset-bpo pull-right" rel="tooltip" title="Blueprint original, valued at NPC base price"></i>
                  {%- elif asset.z_blueprint == -2 %}
                  <i class="icons-asset-bpc pull-right" rel="tooltip" title="Blueprint copy, valued at 0 for now"></i>
                  {%- endif -%}
                </td>
                <td class="assets-type c">{{ asset.z_item.item_group.category.name }}</td>
                <td class="assets-quantity r">{{ asset.quantity|commas }}</td>
                <td class="assets-value r">
                  {%- if asset.z_capital %}<i class="icons-information pull-left" rel="tooltip" title="ME2 hull, ME50 component, minerals from buys"></i>{% endif %}
                  {{ asset.z_price|commas }}
                </td>
                <td class="assets-value r">{{ asset.z_total|commas }}</td>
              </tr>
              {% if asset.z_contents -%}
              {% for content in asset.z_contents -%}
              <tr class="asset-sneaky asset-{{ asset.id }}">
                <td></td>
                <td>
                  <i class="icons-indent"></i>
                  {%- if content.z_locked %}<i class="icons-asset-locked"></i>{% endif %}
                  {% if show_item_icons -%}
                  <img src="http://image.eveonline.com/Type/{{ content.z_item.id }}_32.png" height="16" width="16">
                  {%- endif %}
                  {{ content.z_item.name }}
                  {%- if content.z_blueprint == -1 %}
                  <i class="icons-asset-bpo pull-right" rel="tooltip" title="Blueprint original, valued at NPC base price"></i>
                  {%- elif content.z_blueprint == -2 %}
                  <i class="icons-asset-bpc pull-right" rel="tooltip" title="Blueprint copy, valued at 0 for now"></i>
                  {%- endif %}
                </td>
                <td class="c">{{ content.z_group }}</td>
                <td class="r">{{ content.quantity|commas }}</td>
                <td class="assets-value r">
                  {%- if content.z_capital %}<i class="icons-information pull-left" rel="tooltip" title="ME2 hull, ME50 component, minerals from buys"></i>{% endif %}
                  {{ content.z_price|commas }}
                </td>
                <td class="r">{{ content.z_total|commas }}</td>
              </tr>
              {%- endfor %}
              {% if asset.z_mod == 1 %}<tr></tr>{% endif %}
              {%- endif %}{% endfor %}
              <tr>
                <td colspan="4"></td>
                <td class="assets-total r" colspan="2">{{ loc_totals[system_name]|commas }}</td>
              </tr>
            </tbody>
          </table>
          {%- endfor %}
          {%- endwith %}
        </div>
      </div>

      <div class="modal hide" id="eft-modal">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal"><i class="icons-close"></i></button>
          <h3>EFT Fitting</h3>
        </div>
        <div class="modal-body">
          <div class="row-fluid">
            <div class="span12">
              <textarea id="eft-textarea" rows="20" style="width: 98%;">
              </textarea>
            </div>
          </div>
        </div>
      </div>
{% endblock %}
