{% extends "base.html" %}

{% block extra_head %}
      <script type="text/javascript">
        $(document).ready(function() {
          // Javascript to enable link to tab
          var prefix = 'tab_';
          var hash = document.location.hash;
          if (hash) {
            $('.nav-tabs a[href=' + hash.replace(prefix, "") + ']').tab('show');
          }
          
          // Change hash for page-reload
          $('.nav-tabs a').on('shown', function (e) {
            window.location.hash = e.target.hash.replace('#', '#' + prefix);
          });
          
          $('.edit-skillplan').on('click', function(event) {
            var sp_id = $(this).parents('tr').attr('data-id');
            var sp_name = $('td:nth-child(2)', $(this).parents('tr')).text();
            var sp_vis = $(this).parents('tr').attr('data-vis');
            $('#edit-skillplan-id').val(sp_id);
            $('#edit-skillplan-name').val(sp_name);
            $('#edit-skillplan-visibility').val(sp_vis);
          });

          $('.delete-skillplan').on('click', function(event) {
            var sp_id = $(this).parents('tr').attr('data-id');
            var sp_name = $('td:nth-child(2)', $(this).parents('tr')).text();
            $('#delete-skillplan-id').val(sp_id);
            $('#delete-skillplan-name').val(sp_name);
          });
        });
      </script>
{% endblock %}

{% block title %}Account Management{% endblock %}

{% block content %}
      <div class="row-fluid">
        <div class="span10">
          <h2>Account Management</h2>
          
          {% if message -%}
          <div class="alert alert-{{ message_type }}">
            <strong>{{ message_type|capfirst }}:</strong> {{ message }}
          </div>
          {%- endif %}

          <ul class="nav nav-tabs">
            <li class="active"><a href="#settings" data-toggle="tab">Settings</a></li>
            <li><a href="#skillplans" data-toggle="tab">Skill Plans</a></li>
            <li><a href="#password" data-toggle="tab">Change Password</a></li>
          </ul>

          <div class="tab-content">
            <div class="tab-pane active" id="settings">
              <form action="{% url thing.views.account_settings %}" method="POST" class="form-horizontal">
                <fieldset>
                  {% csrf_token %}
                  <div class="control-group">
                    <label class="control-label" for="theme">Theme</label>
                    <div class="controls">
                      <select name="theme">
                        {% for value, display in themes %}
                        <option value="{{ value }}"{% if profile.theme == value %} selected{% endif %}>{{ display }}</option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                </fieldset>
                <fieldset>
                  <legend>Home page</legend>
                  <div class="control-group">
                    <label class="control-label" for="home_chars_per_row">Characters per row</label>
                    <div class="controls">
                      <select name="home_chars_per_row">
                        {% for n in home_chars_per_row %}
                        <option value="{{ n }}"{% if profile.home_chars_per_row == n %} selected{% endif %}>{{ n }}</option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                  <div class="control-group">
                    <label class="control-label" for="home_sort_order">Sort order</label>
                    <div class="controls">
                      <select name="home_sort_order">
                        {% for value, name in home_sort_orders %}
                        <option value="{{ value }}"{% if profile.home_sort_order == value %} selected{% endif %}>{{ name }}</option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                  <div class="control-group">
                    <label class="control-label" for="home_sort_descending">Sort descending?</label>
                    <div class="controls">
                      <input type="checkbox" name="home_sort_descending"{% if profile.home_sort_descending %} checked{% endif %}>
                    </div>
                  </div>
                </fieldset>
                <fieldset>
                  <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save changes</button>
                  </div>
                </fieldset>
              </form>
            </div>

            <div class="tab-pane" id="skillplans">
              <div class="span6">
                <h3>Add new skill plan</h3>
                <form class="well form-horizontal" action="{% url thing.views.account_skillplan_add %}" method="POST" enctype="multipart/form-data">
                  {% csrf_token %}
                  <fieldset>
                    <div class="control-group">
                      <label class="control-label" for="name">Plan name</label>
                      <div class="controls">
                        <input type="text" class="input-large" name="name">
                      </div>
                    </div>
                    <div class="control-group">
                      <label class="control-label" for="file">.EMP file</label>
                      <div class="controls">
                        <input class="input-file" name="file" type="file">
                      </div>
                    </div>
                    <div class="control-group">
                      <label class="control-label" for="visibility">Visibility</label>
                      <div class="controls">
                        <select name="visibility">
                          {% for value, text in visibilities -%}
                          <option value="{{ value }}">{{ text }}</option>
                          {%- endfor %}
                        </select>
                        <p class="help-block">Private: visibile only to your user account.</p>
                        <p class="help-block">Public: visibile to anyone on <u>your</u> character pages.</p>
                        <p class="help-block">Global: visibile to anyone on any character page.</p>
                      </div>
                    </div>
                  </fieldset>
                  <fieldset>
                    <div class="form-actions" style="margin-bottom: 0; padding-bottom: 0;">
                      <button type="submit" class="btn btn-primary">Upload</button>
                    </div>
                  </fieldset>
                </form>

                <h4>Existing skill plans</h4>
                <table class="table table-striped table-bordered table-condensed">
                  <thead>
                    <tr class="c">
                      <th>ID</th>
                      <th>Name</th>
                      <th>Visibility</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for skillplan in skillplans -%}
                    <tr data-id="{{ skillplan.id }}" data-vis="{{ skillplan.visibility }}">
                      <td class="r sp-trained">{{ skillplan.id }}</td>
                      <td>{{ skillplan.name }}</td>
                      <td class="c sp-time">{{ skillplan.get_visibility_display() }}</td>
                      <td class="c sp-trained">
                        <a class="edit-skillplan" data-toggle="modal" href="#edit-skillplan-modal"><i class="icon-pencil"></i></a>
                        <a class="delete-skillplan" data-toggle="modal" href="#delete-skillplan-modal"><i class="icon-trash"></i></a>
                      </td>
                    </tr>
                    {%- else %}
                    <tr>
                      <td colspan="4">You have no skill plans.</td>
                    </tr>
                    {%- endfor %}
                  </tbody>
                </table>
              </div>
            </div>

            <div class="tab-pane" id="password">
              <form action="{% url thing.views.account_change_password %}" method="POST" class="form-horizontal">
                <fieldset>
                  {% csrf_token %}
                  <div class="control-group">
                    <label class="control-label" for="old_password">Old password</label>
                    <div class="controls">
                      <input type="password" name="old_password">
                    </div>
                  </div>
                  <div class="control-group">
                    <label class="control-label" for="new_password">New password</label>
                    <div class="controls">
                      <input type="password" name="new_password">
                    </div>
                  </div>
                  <div class="control-group">
                    <label class="control-label" for="confirm_password">Confirm password</label>
                    <div class="controls">
                      <input type="password" name="confirm_password">
                    </div>
                  </div>
                </fieldset>
                <fieldset>
                  <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Change password</button>
                  </div>
                </fieldset>
              </form>
            </div>

            <div class="modal hide" id="edit-skillplan-modal">
              <form action="{% url thing.views.account_skillplan_edit %}" method="POST" class="form-horizontal">
                {% csrf_token %}
                <input type="hidden" name="skillplan_id" value="" id="edit-skillplan-id">
                <div class="modal-header">
                  <a class="close" data-dismiss="modal">×</a>
                  <h3>Edit Skill Plan</h3>
                </div>
                <div class="modal-body">
                  <fieldset>
                    <div class="control-group">
                      <label class="control-label" for="blueprint">Name</label>
                      <div class="controls">
                        <input type="text" id="edit-skillplan-name" name="name" value="">
                      </div>
                    </div>
                    <div class="control-group">
                      <label class="control-label" for="ml">Visibility</label>
                      <div class="controls">
                        <select id="edit-skillplan-visibility" name="visibility">
                          {% for value, text in visibilities -%}
                          <option value="{{ value }}">{{ text }}</option>
                          {%- endfor %}
                        </select>
                        <p class="help-block">Private: visibile only to your user account.</p>
                        <p class="help-block">Public: visibile to anyone on <u>your</u> character pages.</p>
                        <p class="help-block">Global: visibile to anyone on any character page.</p>
                      </div>
                    </div>
                  </fieldset>
                </div>
                <div class="modal-footer">
                  <button class="btn btn-danger" data-dismiss="modal"><i class="icon-remove icon-white"></i> Cancel</button>
                  <button type="submit" class="btn btn-success"><i class="icon-ok icon-white"></i> Save</button>
                </div>
              </form>
            </div>

            <div class="modal hide" id="delete-skillplan-modal">
              <form action="{% url thing.views.account_skillplan_delete %}" method="POST" class="form-inline">
                {% csrf_token %}
                <input type="hidden" name="skillplan_id" value="" id="delete-skillplan-id">
                <div class="modal-header">
                  <a class="close" data-dismiss="modal">×</a>
                  <h3>Delete Confirmation</h3>
                </div>
                <div class="modal-body">
                  <p>
                    Are you sure you wish to delete the skill plan named "<span id="delete-skillplan-name"></span>"?
                  </p>
                </div>
                <div class="modal-footer">
                  <button class="btn btn-success" data-dismiss="modal"><i class="icon-remove icon-white"></i> No</button>
                  <button type="submit" class="btn btn-danger"><i class="icon-ok icon-white"></i> Yes</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
{% endblock %}
